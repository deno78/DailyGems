# Android Build Fix: "invalid source release: 21"

## Problem
The Android build was failing with the error "invalid source release: 21" because various Capacitor dependencies and auto-generated files were configured to use Java 21, while the GitHub Actions environment and build tools expected Java 17.

## Root Cause Analysis
Multiple Gradle files contained `JavaVersion.VERSION_21` settings:

1. **`android/app/capacitor.build.gradle`** (auto-generated by Capacitor)
2. **`node_modules/@capacitor/android/capacitor/build.gradle`** (Capacitor core dependency)
3. **`node_modules/@capacitor-community/admob/android/build.gradle`** (AdMob plugin dependency)
4. **`android/capacitor-cordova-android-plugins/build.gradle`** (generated Cordova plugins module)

## Solution Implemented

### 1. Global Subproject Configuration
Added a comprehensive override in `android/build.gradle` to force all Android subprojects to use Java 17:

```gradle
// Force all subprojects to use Java 17 to avoid "invalid source release: 21" errors
// This is necessary because Capacitor dependencies may use Java 21 by default
subprojects {
    afterEvaluate { project ->
        if (project.hasProperty('android')) {
            project.android {
                compileOptions {
                    sourceCompatibility JavaVersion.VERSION_17
                    targetCompatibility JavaVersion.VERSION_17
                }
            }
        }
    }
}
```

This configuration:
- Applies to ALL Android subprojects (app, capacitor-android, capacitor-community-admob, etc.)
- Uses `afterEvaluate` to ensure our settings override individual module settings
- Only affects Android modules (checked via `hasProperty('android')`)
- Sets both source and target compatibility to Java 17

### 2. Existing App-Level Override
The main app already had a local override in `android/app/build.gradle` which serves as an additional safety measure:

```gradle
// Override placed AFTER 'capacitor.build.gradle' to take precedence
android {
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_17
        targetCompatibility JavaVersion.VERSION_17
    }
}
```

### 3. GitHub Actions Configuration
The workflow in `.github/workflows/android-build.yml` correctly uses Java 17:

```yaml
- name: Setup Java JDK
  uses: actions/setup-java@v4
  with:
    distribution: 'temurin'
    java-version: '17'
```

## Technical Details

### Why This Approach Works
1. **Gradle Build Order**: The `subprojects` block with `afterEvaluate` ensures our Java 17 settings are applied after each subproject's own build.gradle has been processed
2. **Comprehensive Coverage**: This approach catches all Android modules, including those in node_modules and auto-generated directories
3. **Non-Intrusive**: We don't modify files in node_modules or auto-generated directories that could be overwritten

### Affected Modules
The solution ensures these modules all use Java 17:
- `:app` (main Android application)
- `:capacitor-android` (Capacitor core Android runtime)
- `:capacitor-community-admob` (AdMob integration plugin)
- `:capacitor-cordova-android-plugins` (Cordova plugin compatibility layer)

## Verification
To verify the fix works:

1. Run `npx cap sync android` to ensure all auto-generated files are current
2. Build the Android project: `cd android && ./gradlew assembleDebug`
3. Check that no "invalid source release: 21" errors occur

## Maintenance Notes
- The global override in `android/build.gradle` should persist across Capacitor updates
- Individual module overrides may be regenerated by `npx cap sync`, but the global configuration will still apply
- When updating Capacitor versions, verify that new dependencies still work with Java 17

## Related Files
- `android/build.gradle` - Contains the global Java 17 override
- `android/app/build.gradle` - Contains app-specific Java 17 override
- `.github/workflows/android-build.yml` - GitHub Actions Java 17 configuration
- Auto-generated files that are overridden by this fix:
  - `android/app/capacitor.build.gradle`
  - `android/capacitor-cordova-android-plugins/build.gradle`